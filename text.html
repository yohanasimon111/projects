<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - HopeLink Mahama</title>
   
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
   
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        /* (Keep all your existing CSS styles) */
        /* ... existing styles ... */
    </style>
</head>
<body class="font-sans">
    <!-- Firebase Configuration Script -->
    <script type="module">
        // (Keep all your existing Firebase configuration)
        // ... existing Firebase code ...
    </script>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 p-3 rounded-xl">
                        <i class="fas fa-hands-helping text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-xl text-gray-800">HopeLink</div>
                        <div class="text-xs text-green-500 font-semibold">Mahama Refugee Camp</div>
                    </div>
                </div>
                <a href="index.html" class="btn-primary px-6 py-2.5 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-home"></i>
                    <span>Back to Home</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- (Keep all your existing HTML structure) -->
    <!-- ... existing HTML ... -->

    <script>
        // ============================================================================
        // ENHANCED AUTHENTICATION SYSTEM WITH ADMIN/USER ROLE MANAGEMENT
        // ============================================================================

        // Global state
        let currentView = 'login';
        let currentResetEmail = '';
        let otpCode = '';
        let otpTimer;
        let resendTimer;

        // Check if user is first user to become admin
        function checkIfFirstUser() {
            const users = JSON.parse(localStorage.getItem('hopelink_users') || '[]');
            return users.length === 0; // First user becomes admin
        }

        // Get all users from localStorage
        function getAllUsers() {
            return JSON.parse(localStorage.getItem('hopelink_users') || '[]');
        }

        // Save user to localStorage
        function saveUserToLocal(userData) {
            const users = getAllUsers();
            users.push(userData);
            localStorage.setItem('hopelink_users', JSON.stringify(users));
        }

        // Update user in localStorage
        function updateUserInLocal(userId, updates) {
            const users = getAllUsers();
            const index = users.findIndex(u => u.uid === userId);
            if (index !== -1) {
                users[index] = { ...users[index], ...updates };
                localStorage.setItem('hopelink_users', JSON.stringify(users));
            }
        }

        // Get user by email from localStorage
        function getUserByEmailLocal(email) {
            const users = getAllUsers();
            return users.find(u => u.email === email);
        }

        // Notification functions (keep existing)
        function showNotification(message, type = 'success', detail = '') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
           
            notification.className = `notification ${type}`;
            icon.className = type === 'success' ? 'fas fa-check-circle' :
                           type === 'error' ? 'fas fa-exclamation-circle' :
                           'fas fa-info-circle';
           
            if (detail) {
                messageEl.innerHTML = `${message}<br><small>${detail}</small>`;
            } else {
                messageEl.textContent = message;
            }
           
            notification.classList.add('show');
           
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // Utility functions (keep existing)
        function showLoading(buttonId, spinnerId, buttonTextId, loadingText) {
            const button = document.querySelector(buttonId);
            const spinner = document.getElementById(spinnerId);
            const buttonText = document.getElementById(buttonTextId);
           
            button.disabled = true;
            buttonText.textContent = loadingText;
            spinner.classList.remove('hidden');
        }

        function hideLoading(buttonId, spinnerId, buttonTextId, originalText) {
            const button = document.querySelector(buttonId);
            const spinner = document.getElementById(spinnerId);
            const buttonText = document.getElementById(buttonTextId);
           
            button.disabled = false;
            buttonText.textContent = originalText;
            spinner.classList.add('hidden');
        }

        // ============================================================================
        // ENHANCED SIGNUP FUNCTIONALITY WITH ROLE ASSIGNMENT
        // ============================================================================

        async function handleSignup(e) {
            e.preventDefault();
           
            const firstName = document.getElementById('signup-firstname').value;
            const lastName = document.getElementById('signup-lastname').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const termsAgreed = document.getElementById('terms-agreement').checked;
           
            showLoading('#signupForm button[type="submit"]', 'signup-spinner', 'signup-button-text', 'Creating Account...');
            hideError('signup-error');
            hideError('signup-success');

            try {
                // Validate inputs
                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    throw new Error('Please fill in all fields');
                }

                if (!termsAgreed) {
                    throw new Error('Please agree to the Terms of Service and Privacy Policy');
                }

                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }

                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters long');
                }

                // Check if user already exists
                const existingUser = getUserByEmailLocal(email);
                if (existingUser) {
                    throw new Error('An account with this email already exists');
                }

                // Check if this is the first user (becomes admin)
                const isFirstUser = checkIfFirstUser();
                const userRole = isFirstUser ? 'admin' : 'user';
                const userStatus = isFirstUser ? 'approved' : 'pending'; // First admin is auto-approved
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Create user object
                const userId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                const userData = {
                    uid: userId,
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    password: password, // In real app, this should be hashed
                    role: userRole,
                    status: userStatus,
                    profileComplete: false,
                    photoURL: `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=random`,
                    phoneNumber: '',
                    address: '',
                    bio: '',
                    joinDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isActive: true,
                    permissions: userRole === 'admin' ? ['all'] : ['view', 'edit_profile']
                };

                // Save to localStorage
                saveUserToLocal(userData);

                // Store current session
                sessionStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('rememberedUser', JSON.stringify({
                    email: email,
                    remember: true
                }));

                if (isFirstUser) {
                    showSuccess('signup-success', 'Congratulations! You are the first user and have been granted Admin privileges. Redirecting to dashboard...');
                    showNotification('Admin account created!', 'success', 'Welcome to HopeLink Admin Dashboard!');
                    
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showSuccess('signup-success', 'Account created successfully! Your account is pending approval by an admin.');
                    showNotification('Account created!', 'success', 'Your account is pending approval. You will receive an email when approved.');
                    
                    setTimeout(() => {
                        document.getElementById('signupForm').reset();
                        switchAuthView('login');
                        document.getElementById('login-email').value = email;
                    }, 3000);
                }

            } catch (error) {
                console.error('Signup error:', error);
                showError('signup-error', error.message);
                showNotification('Signup failed', 'error', error.message);
            } finally {
                hideLoading('#signupForm button[type="submit"]', 'signup-spinner', 'signup-button-text', 'Create Account');
            }
        }

        // ============================================================================
        // ENHANCED LOGIN FUNCTIONALITY WITH ROLE CHECK
        // ============================================================================

        async function handleLogin(e) {
            e.preventDefault();
           
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
           
            showLoading('#loginForm button[type="submit"]', 'login-spinner', 'login-button-text', 'Signing In...');
            hideError('login-error');
            hideError('login-success');

            try {
                // Validate inputs
                if (!email || !password) {
                    throw new Error('Please fill in all fields');
                }

                // Check credentials
                const users = getAllUsers();
                const user = users.find(u => u.email === email && u.password === password);
               
                if (!user) {
                    throw new Error('Invalid email or password');
                }

                // Check if account is approved
                if (user.status !== 'approved') {
                    throw new Error('Your account is pending approval. Please wait for admin approval.');
                }

                // Check if account is active
                if (!user.isActive) {
                    throw new Error('Your account has been deactivated. Please contact support.');
                }

                // Update last login
                user.lastLogin = new Date().toISOString();
                updateUserInLocal(user.uid, { lastLogin: user.lastLogin });

                // Save remembered email
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                // Store user session
                sessionStorage.setItem('currentUser', JSON.stringify(user));

                showSuccess('login-success', `Welcome back, ${user.fullName}! Redirecting...`);
                
                if (user.role === 'admin') {
                    showNotification(`Admin login successful!`, 'success', `Welcome to the Admin Dashboard, ${user.fullName}!`);
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showNotification(`Login successful!`, 'success', `Welcome back, ${user.fullName}!`);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }

            } catch (error) {
                console.error('Login error:', error);
                showError('login-error', error.message);
                showNotification('Login failed', 'error', error.message);
            } finally {
                hideLoading('#loginForm button[type="submit"]', 'login-spinner', 'login-button-text', 'Sign In');
            }
        }

        // ============================================================================
        // ADDITIONAL HELPER FUNCTIONS
        // ============================================================================

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('hidden');
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // (Keep all your existing OTP, timer, and password reset functions)
        // ... existing functions ...

        // ============================================================================
        // VIEW MANAGEMENT
        // ============================================================================

        function switchAuthView(view) {
            currentView = view;
           
            // Update tabs
            document.getElementById('login-tab').classList.toggle('tab-active', view === 'login');
            document.getElementById('signup-tab').classList.toggle('tab-active', view === 'signup');
            document.getElementById('login-tab').classList.toggle('text-gray-500', view !== 'login');
            document.getElementById('signup-tab').classList.toggle('text-gray-500', view !== 'signup');
           
            // Update containers
            document.getElementById('login-form-container').classList.toggle('hidden', view !== 'login');
            document.getElementById('signup-form-container').classList.toggle('hidden', view !== 'signup');
            document.getElementById('forgot-password-container').classList.toggle('hidden', view !== 'forgot-password');
            document.getElementById('otp-verification-container').classList.toggle('hidden', view !== 'otp-verification');
            document.getElementById('new-password-container').classList.toggle('hidden', view !== 'new-password');
            document.getElementById('reset-success-container').classList.toggle('hidden', view !== 'reset-success');
           
            // Clear errors
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.classList.add('hidden');
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function initializeTabs() {
            document.getElementById('login-tab').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('signup-tab').addEventListener('click', () => switchAuthView('signup'));
            document.getElementById('forgot-password-btn').addEventListener('click', () => switchAuthView('forgot-password'));
            document.getElementById('back-to-login').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('back-to-email').addEventListener('click', () => switchAuthView('forgot-password'));
            document.getElementById('back-to-otp').addEventListener('click', () => switchAuthView('otp-verification'));
            document.getElementById('go-to-login').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('resend-otp-btn').addEventListener('click', handleResendOtp);
        }

        function initializeForms() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            // (Keep other form event listeners)
        }

        function checkRememberedUser() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('login-email').value = rememberedEmail;
                document.getElementById('remember-me').checked = true;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeForms();
            checkRememberedUser();
           
            console.log('Enhanced Authentication System Ready');
            console.log('First user becomes Admin, subsequent users need approval');
        });

    </script>
</body>
</html>